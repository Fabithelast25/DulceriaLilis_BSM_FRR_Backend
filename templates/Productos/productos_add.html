<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agregar Producto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* ===== Paleta ===== */
    :root{
      --brand-red:#c8102e;
      --brand-red-700:#a40d25;
      --brand-red-50:#fff5f7;
      --brand-gold:#d4af37;
      --brand-gold-700:#b89617;
      --brand-gold-100:#fcf6e6;
      --ink:#1c1d22;
      --muted:#6b7280;
      --border:#e8e8e8;
      --bg:#ffffff;
      --page:#fafafa;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:14px;
    }

    html,body{height:100%}
    body{
      background: linear-gradient(180deg, var(--page), #fff);
      margin:0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
    }

    /* Navbar consistente */
    .navbar{
      background: var(--brand-red) !important;
      box-shadow: 0 8px 18px rgba(200,16,46,.18);
    }
    .navbar-brand{ color:#fff !important; font-weight:800; letter-spacing:.3px; }
    .nav-link{ color:#fff !important; opacity:.95; }
    .nav-link:hover{ opacity:1; text-decoration: underline; text-underline-offset: 4px; }

    /* Contenedor tarjeta */
    .page-wrap{ padding:24px 12px; }
    .card{
      max-width:980px; margin:0 auto; background:var(--bg); border-radius:var(--radius);
      box-shadow:var(--shadow); border:1px solid var(--border); overflow:hidden;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, #fff, var(--brand-gold-100));
      border-bottom:2px solid var(--brand-gold);
      padding:14px 18px; font-weight:800; font-size:1.1rem; color:var(--ink);
    }
    .card-header:before{
      content:""; width:10px; height:22px; border-radius:8px;
      background: linear-gradient(180deg, var(--brand-gold), var(--brand-gold-700));
      box-shadow:0 4px 10px rgba(212,175,55,.25);
    }
    .body{ padding:18px; }

    /* Tabs / pasos */
    .steps{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
    .btn-step{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:9px 12px; font-weight:700; }
    .btn-step.active{ border-color:var(--brand-gold); box-shadow:0 0 0 .2rem rgba(212,175,55,.18); }

    .form-section{ display:none; } .form-section.active{ display:block; }

    /* Campos */
    label{ font-weight:700; margin-bottom:6px; display:block; }
    .form-control, .form-select, textarea{
      width:100%; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff;
    }
    .form-control:focus, .form-select:focus, textarea:focus{
      border-color: var(--brand-gold); box-shadow: 0 0 0 .2rem rgba(212,175,55,.18);
    }
    .help{ font-size:.9rem; color:var(--muted); margin-top:4px; }
    .field-errors, .field-error{ color:#8f0c1f; font-weight:600; font-size:.9rem; margin-top:6px; display:none; }
    .invalid{ border-color:#dc3545 !important; box-shadow:0 0 0 .2rem rgba(220,53,69,.15) !important; }

    .non-field-errors{
      background:#fff3cd; border:1px solid #ffe08a; color:#7a5b00; padding:10px; border-radius:10px; margin-bottom:12px;
    }

    /* Botones */
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:16px; }
    .btn-gold{
      background: linear-gradient(180deg, var(--brand-gold), var(--brand-gold-700));
      color:#1a1a1a; border:none; border-radius:10px; padding:10px 14px; font-weight:800;
    }
    .btn-gold:hover{ filter:brightness(.95); color:#111; }
    .btn-outline{
      background:#fff; color:var(--brand-red); border:2px solid var(--brand-red); border-radius:10px; padding:9px 14px; font-weight:800;
    }
    .btn-outline:hover{ background:var(--brand-red-50); }

    @media (max-width: 720px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>

  {% include 'Productos/navbar_productos.html' %}

  <div class="page-wrap">
    <div class="card">
      <div class="card-header">
        <div>Agregar Producto</div>
        <a class="btn btn-outline" href="{% url 'productos' %}">Volver a la lista</a>
      </div>

      <div class="body">
        {% if form.non_field_errors %}
          <div class="non-field-errors">{{ form.non_field_errors }}</div>
        {% endif %}
        {% if errors %}
          <div class="non-field-errors">
            <ul class="mb-0">
              {% for field_errors in errors.values %}
                {% for error in field_errors %}<li>{{ error }}</li>{% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <!-- Pasos -->
        <div class="steps">
          <button type="button" class="btn-step active" data-section="form1">1. Identificación y precios</button>
          <button type="button" class="btn-step" data-section="form2">2. Stock y control</button>
          <button type="button" class="btn-step" data-section="form3">3. Relaciones y derivados</button>
        </div>

        <form method="post" id="form_producto" novalidate>
          {% csrf_token %}

          <!-- ========== Sección 1 ========== -->
          <section id="form1" class="form-section active">
            <h5 class="mb-3">Identificación</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="{{ form.sku.id_for_label }}">SKU</label>
                {{ form.sku }}
                <div class="field-error" id="err-sku">Formato inválido (3–32: letras/números/._-)</div>
              </div>
              <div class="col-md-4">
                <label for="{{ form.ean_upc.id_for_label }}">EAN/UPC</label>
                {{ form.ean_upc }}
                <div class="field-error" id="err-ean">Debe ser numérico de 8, 12 o 13 dígitos (opcional).</div>
              </div>
              <div class="col-md-4">
                <label for="{{ form.nombre.id_for_label }}">Nombre</label>
                {{ form.nombre }}
                <div class="field-error" id="err-nombre">Entre 3 y 70 caracteres.</div>
              </div>

              <div class="col-12">
                <label for="{{ form.descripcion.id_for_label }}">Descripción</label>
                {{ form.descripcion }}
                <div class="field-error" id="err-desc">Máx. 300 caracteres.</div>
              </div>

              <div class="col-md-6">
                <label for="{{ form.categoria.id_for_label }}">Categoría</label>
                {{ form.categoria }}
                <div class="field-error" id="err-categoria">Selecciona una categoría válida.</div>
              </div>
              <div class="col-md-6">
                <label for="{{ form.marca.id_for_label }}">Marca</label>
                {{ form.marca }}
                <div class="field-error" id="err-marca">Máx. 50 caracteres.</div>
              </div>
              <div class="col-md-6">
                <label for="{{ form.modelo.id_for_label }}">Modelo</label>
                {{ form.modelo }}
                <div class="field-error" id="err-modelo">Máx. 50 caracteres.</div>
              </div>
            </div>

            <h5 class="mt-4 mb-3">Unidades y precios</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="{{ form.uom_compra.id_for_label }}">Unidad de Medida (Compra)</label>
                {{ form.uom_compra }}
                <div class="field-error" id="err-uomc">Obligatorio.</div>
              </div>
              <div class="col-md-4">
                <label for="{{ form.uom_venta.id_for_label }}">Unidad de Medida (Venta)</label>
                {{ form.uom_venta }}
                <div class="field-error" id="err-uomv">Obligatorio.</div>
              </div>
              <div class="col-md-4">
                <label for="{{ form.factor_conversion.id_for_label }}">Factor de Conversión</label>
                {{ form.factor_conversion }}
                <div class="field-error" id="err-factor">Entero &gt; 0.</div>
              </div>

              <div class="col-md-3">
                <label for="{{ form.costo_estandar.id_for_label }}">Costo Estándar</label>
                {{ form.costo_estandar }}
                <div class="field-error" id="err-costo-std">Entero ≥ 0 (opcional).</div>
              </div>
              <div class="col-md-3">
                <label for="{{ form.costo_promedio.id_for_label }}">Costo Promedio</label>
                {{ form.costo_promedio }}
                <div class="field-error" id="err-costo-prom">Entero ≥ 0 (opcional).</div>
              </div>
              <div class="col-md-3">
                <label for="{{ form.precio_venta.id_for_label }}">Precio de Venta</label>
                {{ form.precio_venta }}
                <div class="field-error" id="err-precio">Entero ≥ 0 (opcional).</div>
              </div>
              <div class="col-md-3">
                <label for="{{ form.impuesto_iva.id_for_label }}">IVA (%)</label>
                {{ form.impuesto_iva }}
                <div class="field-error" id="err-iva">0 a 100.</div>
              </div>
            </div>
          </section>

          <!-- ========== Sección 2 ========== -->
          <section id="form2" class="form-section">
            <h5 class="mb-3">Stock y control</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="{{ form.stock_minimo.id_for_label }}">Stock Mínimo</label>
                {{ form.stock_minimo }}
                <div class="field-error" id="err-smin">Entero ≥ 0.</div>
              </div>
              <div class="col-md-4">
                <label for="{{ form.stock_maximo.id_for_label }}">Stock Máximo</label>
                {{ form.stock_maximo }}
                <div class="field-error" id="err-smax">Entero ≥ 0 (opcional).</div>
              </div>
              <div class="col-md-4">
                <label for="{{ form.punto_reorden.id_for_label }}">Punto de Reorden</label>
                {{ form.punto_reorden }}
                <div class="field-error" id="err-reorden">Entero ≥ 0 (si vacío, se usa mínimo).</div>
              </div>

              <div class="col-md-4">
                <label for="{{ form.perishable.id_for_label }}">Perecible</label>
                {{ form.perishable }}
              </div>
              <div class="col-md-4">
                <label for="{{ form.control_por_lote.id_for_label }}">Control por Lote</label>
                {{ form.control_por_lote }}
              </div>
              <div class="col-md-4">
                <label for="{{ form.control_por_serie.id_for_label }}">Control por Serie</label>
                {{ form.control_por_serie }}
              </div>
            </div>
          </section>

          <!-- ========== Sección 3 ========== -->
          <section id="form3" class="form-section">
            <h5 class="mb-3">Relaciones y soporte</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="{{ form.imagen_url.id_for_label }}">Imagen URL</label>
                {{ form.imagen_url }}
                <div class="field-error" id="err-url">Debe ser http(s) válido (opcional).</div>
              </div>
              <div class="col-md-6">
                <label for="{{ form.ficha_tecnica_url.id_for_label }}">Ficha Técnica URL</label>
                {{ form.ficha_tecnica_url }}
                <div class="field-error" id="err-ficha">Debe ser http(s) válido (opcional).</div>
              </div>
            </div>

            <h5 class="mt-4 mb-2">Derivados (solo lectura)</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="{{ form.stock_actual.id_for_label }}">Stock Actual</label>
                {{ form.stock_actual }}
              </div>
              <div class="col-md-4">
                <label for="{{ form.alerta_bajo_stock.id_for_label }}">Alerta de Bajo Stock</label>
                {{ form.alerta_bajo_stock }}
              </div>
              <div class="col-md-4">
                <label for="{{ form.alerta_por_vencer.id_for_label }}">Alerta de Vencimiento</label>
                {{ form.alerta_por_vencer }}
              </div>
            </div>
          </section>

          <div class="actions">
            <a class="btn btn-outline" href="{% url 'productos' %}">Cancelar</a>
            <button type="submit" class="btn-gold">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Navegación de secciones ---------- */
    document.querySelectorAll('.btn-step').forEach(b=>{
      b.addEventListener('click',()=>{
        document.querySelectorAll('.btn-step').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.form-section').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        document.getElementById(b.dataset.section).classList.add('active');
      });
    });

    /* ---------- Reglas y helpers de validación ---------- */
    const RE = {
      sku: /^[A-Za-z0-9._-]{3,32}$/,
      ean: /^(?:\d{8}|\d{12}|\d{13})$/,
      entero: /^\d+$/,
      pct: /^(?:\d{1,3})$/,
      url: /^$|^https?:\/\/.+/i
    };
    const q = name => document.querySelector(`[name="${name}"]`);
    function showErr(el, ok, id){
      const msg = document.getElementById(id);
      if(!ok){ el?.classList.add('invalid'); if(msg) msg.style.display='block'; }
      else { el?.classList.remove('invalid'); if(msg) msg.style.display='none'; }
      return ok;
    }
    function sanitizeInteger(el){
      if(!el) return;
      el.value = el.value.replace(/[^\d]/g,''); // solo dígitos
    }
    function setAttrs(){
      // Atributos HTML para bloquear negativos en el navegador
      ['factor_conversion','costo_estandar','costo_promedio','precio_venta','impuesto_iva',
       'stock_minimo','stock_maximo','punto_reorden','stock_actual'].forEach(n=>{
        const el = q(n); if(!el) return;
        el.setAttribute('inputmode','numeric'); el.setAttribute('min','0'); el.setAttribute('step','1');
        el.addEventListener('input', ()=>sanitizeInteger(el));
      });
      // Evita editar derivados si quieres (si el widget no venía disabled)
    }
    setAttrs();

    function validar() {
      let ok = true;

      ok &= showErr(q('sku'), RE.sku.test(q('sku').value), 'err-sku');
      ok &= showErr(q('ean_upc'), (q('ean_upc').value==='' || RE.ean.test(q('ean_upc').value)), 'err-ean');
      ok &= showErr(q('nombre'), q('nombre').value.trim().length>=3 && q('nombre').value.trim().length<=70, 'err-nombre');
      ok &= showErr(q('descripcion'), q('descripcion').value.length<=300, 'err-desc');

      ok &= showErr(q('categoria'), q('categoria').value!=='', 'err-categoria');
      ok &= showErr(q('marca'), (q('marca').value||'').length<=50, 'err-marca');
      ok &= showErr(q('modelo'), (q('modelo').value||'').length<=50, 'err-modelo');

      ok &= showErr(q('uom_compra'), q('uom_compra').value!=='', 'err-uomc');
      ok &= showErr(q('uom_venta'), q('uom_venta').value!=='', 'err-uomv');

      ok &= showErr(q('factor_conversion'),
        RE.entero.test(q('factor_conversion').value) && Number(q('factor_conversion').value) > 0, 'err-factor');

      const enteroVacioOK = (el)=> (el.value==='' || (RE.entero.test(el.value) && Number(el.value) >= 0));
      ok &= showErr(q('costo_estandar'), enteroVacioOK(q('costo_estandar')), 'err-costo-std');
      ok &= showErr(q('costo_promedio'), enteroVacioOK(q('costo_promedio')), 'err-costo-prom');
      ok &= showErr(q('precio_venta'),  enteroVacioOK(q('precio_venta')),  'err-precio');

      ok &= showErr(q('impuesto_iva'),
        RE.pct.test(q('impuesto_iva').value) && Number(q('impuesto_iva').value)>=0 && Number(q('impuesto_iva').value)<=100,
        'err-iva');

      ok &= showErr(q('stock_minimo'), RE.entero.test(q('stock_minimo').value), 'err-smin');
      ok &= showErr(q('stock_maximo'), enteroVacioOK(q('stock_maximo')), 'err-smax');
      ok &= showErr(q('punto_reorden'), enteroVacioOK(q('punto_reorden')), 'err-reorden');

      // Consistencias
      if(ok){
        const smin = Number(q('stock_minimo').value);
        const smax = q('stock_maximo').value==='' ? null : Number(q('stock_maximo').value);
        const reo  = q('punto_reorden').value==='' ? smin : Number(q('punto_reorden').value);

        if(smax !== null && smax < smin){ showErr(q('stock_maximo'), false, 'err-smax'); ok=false; }
        if((smax !== null && (reo < smin || reo > smax)) || (smax===null && reo < smin)){
          showErr(q('punto_reorden'), false, 'err-reorden'); ok=false;
        }
      }

      ok &= showErr(q('imagen_url'), RE.url.test(q('imagen_url').value), 'err-url');
      ok &= showErr(q('ficha_tecnica_url'), RE.url.test(q('ficha_tecnica_url').value), 'err-ficha');

      return !!ok;
    }

    // Limpieza de error al digitar
    document.addEventListener('input', e=>{
      if(e.target.classList.contains('invalid')){
        e.target.classList.remove('invalid');
        const map = {sku:'err-sku', ean_upc:'err-ean', nombre:'err-nombre', descripcion:'err-desc',
          categoria:'err-categoria', marca:'err-marca', modelo:'err-modelo',
          uom_compra:'err-uomc', uom_venta:'err-uomv', factor_conversion:'err-factor',
          costo_estandar:'err-costo-std', costo_promedio:'err-costo-prom', precio_venta:'err-precio',
          impuesto_iva:'err-iva', stock_minimo:'err-smin', stock_maximo:'err-smax',
          punto_reorden:'err-reorden', imagen_url:'err-url', ficha_tecnica_url:'err-ficha'};
        const id = map[e.target.name]; if(id){ const m = document.getElementById(id); if(m) m.style.display='none'; }
      }
    });

    // Submit con validación y autocompletado de punto_reorden si vacío
    document.getElementById('form_producto').addEventListener('submit', function(e){
      // si punto_reorden está vacío, setear al mínimo (como en tu save())
      if(q('punto_reorden') && q('punto_reorden').value===''){
        q('punto_reorden').value = q('stock_minimo')?.value || 0;
      }
      if(!validar()){
        e.preventDefault();
        const first = document.querySelector('.invalid');
        if(first){
          const section = first.closest('.form-section')?.id || 'form1';
          document.querySelectorAll('.btn-step').forEach(x=>x.classList.remove('active'));
          document.querySelectorAll('.form-section').forEach(x=>x.classList.remove('active'));
          document.querySelector(`.btn-step[data-section="${section}"]`)?.classList.add('active');
          document.getElementById(section)?.classList.add('active');
          first.focus();
        }
      }
    });
  </script>
</body>
</html>
