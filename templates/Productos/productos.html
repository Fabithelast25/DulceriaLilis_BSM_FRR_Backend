<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista de Productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ===== Paleta y tokens (mismo estilo que ofertas_form) ===== */
    :root{
      --brand-red:#c8102e;
      --brand-red-700:#a40d25;
      --brand-red-50:#fff5f7;
      --brand-gold:#d4af37;
      --brand-gold-700:#b89617;
      --brand-gold-100:#fcf6e6;
      --ink:#1c1d22;
      --muted:#6b7280;
      --border:#e8e8e8;
      --bg:#ffffff;
      --page:#fafafa;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:14px;
    }

    html,body{height:100%}
    body{
      background: linear-gradient(180deg, var(--page), #fff);
      margin:0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
    }

    /* Navbar consistente */
    .navbar{
      background: var(--brand-red) !important;
      box-shadow: 0 8px 18px rgba(200,16,46,.18);
    }
    .navbar-brand{ color:#fff !important; font-weight:800; letter-spacing:.3px; }
    .nav-link{ color:#fff !important; opacity:.95; }
    .nav-link:hover{ opacity:1; text-decoration: underline; text-underline-offset: 4px; }

    /* Contenedor tarjeta */
    .page-wrap{ padding:24px 12px; }
    .card{
      max-width:1200px; margin:0 auto; background:var(--bg); border-radius:var(--radius);
      box-shadow:var(--shadow); border:1px solid var(--border); overflow:hidden;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, #fff, var(--brand-gold-100));
      border-bottom:2px solid var(--brand-gold);
      padding:14px 18px; font-weight:800; font-size:1.1rem; color:var(--ink);
    }
    .card-header .mark{
      width:10px; height:22px; border-radius:8px; margin-right:6px;
      background: linear-gradient(180deg, var(--brand-gold), var(--brand-gold-700));
      box-shadow:0 4px 10px rgba(212,175,55,.25);
    }
    .body{ padding:18px; }

    /* Toolbar filtros */
    .toolbar{ display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:12px; margin-bottom:14px; }
    .toolbar .form-control, .toolbar .form-select{
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff;
    }
    .toolbar .form-control:focus, .toolbar .form-select:focus{
      border-color: var(--brand-gold); box-shadow: 0 0 0 .2rem rgba(212,175,55,.18);
    }

    /* Botones marca */
    .btn-gold{
      background: linear-gradient(180deg, var(--brand-gold), var(--brand-gold-700));
      color:#1a1a1a; border:none; border-radius:10px; padding:10px 14px; font-weight:800;
    }
    .btn-gold:hover{ filter:brightness(.95); color:#111; }
    .btn-outline{
      background:#fff; color:var(--brand-red); border:2px solid var(--brand-red); border-radius:10px; padding:9px 14px; font-weight:800;
    }
    .btn-outline:hover{ background:var(--brand-red-50); }

    /* Tabla */
    .table-wrap{ overflow-x:auto; border:1px solid var(--border); border-radius:12px; }
    table{ width:100%; border-collapse: collapse; }
    thead th{
      background:linear-gradient(180deg, #fff, var(--brand-red-50));
      color:#3a3a3a; border-bottom:2px solid var(--brand-gold);
      padding:12px 10px; font-weight:800;
    }
    tbody td{
      background:#fff; padding:12px 10px; border-top:1px solid #eee; vertical-align:middle;
    }
    tbody tr:hover{ background:#fff9f2; }

    /* Badges de estado (por si los usas luego) */
    .estado{ display:inline-block; padding:6px 12px; border-radius:16px; font-weight:700; font-size:.85rem; }
    .activo{ background:#e8f8ea; color:#0f5a14; border:1px solid #c7efcd; }
    .inactivo{ background:#fff9db; color:#6a5600; border:1px solid #ffe08a; }
    .bloqueado{ background:#ffe7e5; color:#6b1204; border:1px solid #ffb3ab; }

    /* Acciones de tabla */
    .btn-edit{
      background:#ffffff; color:#0b3a9b; border:2px solid #7aa7ff; border-radius:10px; padding:6px 10px; font-weight:800;
    }
    .btn-edit:hover{ background:#eef4ff; }
    .btn-delete{
      background:#ffffff; color:#8b0010; border:2px solid #ff808c; border-radius:10px; padding:6px 10px; font-weight:800;
    }
    .btn-delete:hover{ background:#fff1f3; }

    /* Aviso bajo stock */
    .low-stock{
      background:#fff3cd; color:#7a5b00; border:1px solid #ffe08a; border-left:4px solid var(--brand-red);
      padding:10px 12px; border-radius:10px; margin-top:6px;
    }
    /* Normalizar apariencia de los select para que vuelvan a verse correctamente */
    select.form-select {
        appearance: auto !important;
        -webkit-appearance: auto !important;
        background-color: #fff !important;
        color: #000 !important;
        padding: 10px 12px !important;
        border: 1px solid var(--border) !important;
        border-radius: 10px !important;
        height: auto !important;
    }

    select.form-select option {
        background: #fff !important;
        color: #000 !important;
    }


    .boton-exportar {
    font-weight: 700;              /* M치s grueso */
    color: #ffffff !important;     /* Blanco */
    font-size: 17px;               /* Igual al del otro */
    text-shadow: 0px 1px 2px rgba(0,0,0,0.25); /* M치s contraste */
    letter-spacing: 0.3px;         /* Similar al estilo del otro bot칩n */
    }

    /* Protecci칩n extra: si alg칰n contenedor aplica mezcla de colores */
    .toolbar .form-select { color: #000 !important; background: #fff !important; }
    .toolbar .form-select option { color:#000 !important; background:#fff !important; }
    
    @media (max-width: 992px){
      .toolbar{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px){
      .toolbar{ grid-template-columns: 1fr; }
      .card-header{ flex-direction:column; align-items:flex-start; gap:8px; }
    }
  </style>
</head>
<body>

  {% include 'Productos/navbar_productos.html' %}

  <div class="page-wrap">
    <div class="card">
        <div class="card-header">
            <div class="d-flex align-items-center">
                <span class="mark"></span>
                <span>Productos</span>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-gold" href="{% url 'gestion-producto' %}">A침adir Producto</a>
                <a 
                   id="exportar-excel-btn" 
                   href="{% url 'exportar_productos_excel' %}?nombres={{ request.GET.nombres }}&categoria={{ request.GET.categoria }}&unidad_medida={{ request.GET.unidad_medida }}"
                   class="btn btn-success btn-exportar-excel"
                >
                    Exportar Excel
                </a>
            </div>
        </div>

        <div class="body">
            <!-- 游댳 FORMULARIO DE FILTROS -->
            <form method="get" class="toolbar">
            <input type="text" id="buscador" name="nombres" class="form-control" placeholder="Buscar por SKU o nombre" value="{{ nombres }}"/>

            <select id="filtro-categoria" name="categoria" class="form-select" style="color: #000;">
                <option value="">Todas las categor칤as</option>
                {% for c in categorias %}
                    <option value="{{ c.id }}" {% if c.id|stringformat:"s" == categoria %}selected{% endif %}>
                        {{ c.nombre_completo }}
                    </option>
                {% endfor %}
            </select>

            <select id="filtro-unidad" name="unidad_medida" class="form-select" style="color: #000;">
                <option value="">Todas las unidades de medida</option>
                {% for u in unidades_medida %}
                    <option value="{{ u.id }}" {% if u.id|stringformat:"s" == unidad_medida %}selected{% endif %}>
                        {{ u.nombre_completo }}
                    </option>
                {% endfor %}
            </select>

            <!-- Siempre pasa per_page en la URL -->
            <select name="per_page" class="form-select" onchange="this.form.submit()">
                <option value="10" {% if per_page_actual == "10" %}selected{% endif %}>10</option>
                <option value="20" {% if per_page_actual == "20" %}selected{% endif %}>20</option>
                <option value="30" {% if per_page_actual == "30" %}selected{% endif %}>30</option>
                <option value="all" {% if per_page_actual == "all" %}selected{% endif %}>Todos</option>
            </select>
        </form>

            <!-- Tabla -->
            <div class="table-wrap">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Nombre</th>
                  <th class="text-end">Stock</th>
                  <th class="text-center" style="width:220px">Acciones</th>
                </tr>
              </thead>
              <tbody id="tabla-productos">
                {% for p in productos %}
                <tr>
                  <td>{{ p.sku }}</td>
                  <td>
                    <div class="fw-semibold">{{ p.nombre }}</div>
                    {% if p.bajo_stock %}
                    <div class="low-stock mt-2"><strong>춰Atenci칩n!</strong> Stock bajo para <em>{{ p.nombre }}</em>.</div>
                    {% endif %}
                  </td>
                  <td class="text-end">{{ p.stock_actual }}</td>
                  <td class="text-center">
                    <div class="d-inline-flex gap-2">
                      <a href="{% url 'producto-modificado' p.id %}" class="btn btn-sm btn-edit">Editar</a>
                      <a href="{% url 'producto-eliminado' p.id %}" class="btn btn-sm btn-delete" onclick="confirmarEliminacion(event, this)">Eliminar</a>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-4 text-muted">No hay productos para mostrar.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% if productos.paginator.num_pages > 1 and not hide_pagination %}
            <nav aria-label="Paginaci칩n">
                <ul class="pagination">
                    {% if productos.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ productos.previous_page_number }}&nombres={{ nombres }}&categoria={{ categoria }}&unidad_medida={{ unidad_medida }}&per_page={{ per_page }}">
                            Anterior
                        </a>
                    </li>
                    {% endif %}
                    {% for num in productos.paginator.page_range %}
                    <li class="page-item {% if productos.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}&nombres={{ nombres }}&categoria={{ categoria }}&unidad_medida={{ unidad_medida }}&per_page={{ per_page }}">
                            {{ num }}
                        </a>
                    </li>
                    {% endfor %}
                    {% if productos.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ productos.next_page_number }}&nombres={{ nombres }}&categoria={{ categoria }}&unidad_medida={{ unidad_medida }}&per_page={{ per_page }}">
                            Siguiente
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}

          </div>
            </div>
        </div>
    </div>
</div>


  <script>
    function confirmarEliminacion(event, btn) {
      event.preventDefault();
      const url = btn.getAttribute('data-url');
      Swal.fire({
        icon: 'warning',
        title: '쮼liminar producto?',
        text: 'Esta acci칩n eliminar치 el registro de forma permanente.',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'S칤, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            icon: "success",
            title: "춰Eliminado!",
            text: "Producto eliminado de la base de datos",
            showConfirmButton: false,
            timer: 1500
          }).then(() => {
            window.location.href = url;
          });
        }
      });
    }
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
      
      const input = document.getElementById("buscador");
      const tabla = document.getElementById("tabla-productos");

      let timer = null;

      input.addEventListener("input", function () {

          clearTimeout(timer);

          // Espera 300ms para evitar muchas peticiones
          timer = setTimeout(() => {
              const query = input.value;

              fetch(`?nombres=${encodeURIComponent(query)}&ajax=1`)
                  .then(res => res.text())
                  .then(html => {
                      tabla.innerHTML = html;
                  });

          }, 300);
      });

  });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
        // Elementos
        const tabla = document.getElementById("tabla-productos");
        const inputNombre = document.getElementById("buscador");
        const selectCategoria = document.getElementById("filtro-categoria");
        const selectUnidad = document.getElementById("filtro-unidad");
        const exportBtn = document.getElementById("exportar-excel-btn");

        if (!tabla || !inputNombre || !selectCategoria || !selectUnidad || !exportBtn) {
            return;
        }

        // URL base de export (generada por Django)
        const exportBase = "{{ request.scheme }}://{{ request.get_host }}{% url 'exportar_productos_excel' %}";

        // Construye par치metros (sin ajax por defecto)
        function construirParams(includeAjax = false) {
            const params = new URLSearchParams();
            const nombre = inputNombre.value.trim();
            const categoria = selectCategoria.value;
            const unidad = selectUnidad.value;

            if (nombre) params.set("nombres", nombre);
            if (categoria) params.set("categoria", categoria);
            if (unidad) params.set("unidad_medida", unidad);
            if (includeAjax) params.set("ajax", "1");
            return params.toString();
        }

        // Actualiza solo el href del bot칩n export y la URL (sin recargar)
        function actualizarHrefYUrl() {
            const qsSinAjax = construirParams(false);
            const newPath = qsSinAjax ? ("?" + qsSinAjax) : window.location.pathname;
            try {
                window.history.replaceState(null, "", newPath);
            } catch (e) {}

            exportBtn.href = exportBase + (qsSinAjax ? ("?" + qsSinAjax) : "");
        }

        // Llamada AJAX para actualizar tabla
        function actualizarTabla() {
            const qsAjax = construirParams(true);
            const fetchUrl = window.location.pathname + (qsAjax ? ("?" + qsAjax) : "");

            fetch(fetchUrl, { credentials: "same-origin" })
                .then(response => {
                    if (!response.ok) throw new Error("Respuesta no OK");
                    return response.text();
                })
                .then(html => {
                    tabla.innerHTML = html;
                    actualizarHrefYUrl();
                })
                .catch(() => {
                    actualizarHrefYUrl();
                });
        }

        // Evitar env칤o del formulario por Enter
        const filtroForm = document.querySelector("form.toolbar");
        if (filtroForm) {
            filtroForm.addEventListener("submit", function (e) {
                e.preventDefault();
                actualizarTabla();
            });
        }

        // Debounce input
        let debounceTimer = null;
        inputNombre.addEventListener("input", function () {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(actualizarTabla, 300);
        });

        // Cambios selects
        selectCategoria.addEventListener("change", actualizarTabla);
        selectUnidad.addEventListener("change", actualizarTabla);

        // Inicializar href del bot칩n al cargar
        actualizarHrefYUrl();
    });
    </script>
    <script>
  // Delay para evitar que el input dispare miles de requests
  let typingTimer;
  function delayedSubmit() {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      document.getElementById("filterForm").submit();
    }, 500); // medio segundo
  }
</script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Pasamos hide_pagination como una cadena de texto 'true' o 'false'
    var hidePagination = "{{ hide_pagination|yesno:'true,false' }}";
    
    // Si hidePagination es 'true', ocultamos el paginador
    if (hidePagination === 'true') {
        var pagination = document.querySelector('.pagination');
        if (pagination) {
            pagination.style.display = 'none';  // Ocultamos el paginador
        }
    }
  });
</script>





</body>
</html>
