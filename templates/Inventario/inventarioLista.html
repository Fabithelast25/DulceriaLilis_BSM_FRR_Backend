<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista de Movimientos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ===== Paleta corporativa ===== */
    :root{
      --brand-red:#c8102e; --brand-red-700:#a40d25; --brand-red-50:#fff5f7;
      --brand-gold:#d4af37; --brand-gold-700:#b89617; --brand-gold-100:#fcf6e6;
      --ink:#1c1d22; --muted:#6b7280; --border:#e8e8e8; --bg:#ffffff; --page:#fafafa;
      --shadow:0 10px 24px rgba(0,0,0,.08); --radius:14px;
    }
    html,body{height:100%}
    body{ background: linear-gradient(180deg, var(--page), #fff); margin:0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); }

    /* Navbar */
    .navbar{ background: var(--brand-red) !important; box-shadow: 0 8px 18px rgba(200,16,46,.18); }
    .navbar-brand{ color:#fff !important; font-weight:800; letter-spacing:.3px; }
    .nav-link{ color:#fff !important; opacity:.95; }
    .nav-link:hover{ opacity:1; text-decoration: underline; text-underline-offset: 4px; }

    /* Card principal */
    .page-wrap{ padding:24px 12px; }
    .card{
      max-width: 1400px; margin:0 auto; background:var(--bg); border-radius:var(--radius);
      border:1px solid var(--border); box-shadow:var(--shadow); overflow:hidden;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, #fff, var(--brand-gold-100));
      border-bottom:2px solid var(--brand-gold);
      padding:14px 18px; font-weight:800; font-size:1.1rem;
    }
    .card-header .mark{
      width:10px; height:22px; border-radius:8px; margin-right:6px;
      background:linear-gradient(180deg, var(--brand-gold), var(--brand-gold-700));
      box-shadow:0 4px 10px rgba(212,175,55,.25);
    }
    .body{ padding:18px; }

    /* Toolbar filtros */
    .toolbar{ display:grid; grid-template-columns: 1fr 160px 1fr 1fr 120px; gap:12px; margin-bottom:14px; }
    .toolbar .form-control, .toolbar .form-select{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .toolbar .form-control:focus, .toolbar .form-select:focus{ border-color: var(--brand-gold); box-shadow: 0 0 0 .2rem rgba(212,175,55,.18); }

    /* Botones marca */
    .btn-gold{
      background: linear-gradient(180deg, var(--brand-gold), var(--brand-gold-700));
      color:#1a1a1a; border:none; border-radius:10px; padding:10px 14px; font-weight:800;
    }
    .btn-gold:hover{ filter:brightness(.95); color:#111; }
    .btn-outline{
      background:#fff; color:var(--brand-red); border:2px solid var(--brand-red); border-radius:10px; padding:9px 14px; font-weight:800;
    }
    .btn-outline:hover{ background:var(--brand-red-50); }
    .btn-edit{
      background:#ffffff; color:#0b3a9b; border:2px solid #7aa7ff; border-radius:10px; padding:6px 10px; font-weight:800;
    }
    .btn-edit:hover{ background:#eef4ff; }
    .btn-delete{
      background:#ffffff; color:#8b0010; border:2px solid #ff808c; border-radius:10px; padding:6px 10px; font-weight:800;
    }
    .btn-delete:hover{ background:#fff1f3; }

    /* Tabla */
    .table-wrap{ overflow-x:auto; border:1px solid var(--border); border-radius:12px; }
    table{ width:100%; border-collapse: collapse; }
    thead th{
      background:linear-gradient(180deg, #fff, var(--brand-red-50));
      border-bottom:2px solid var(--brand-gold);
      padding:12px 10px; font-weight:800;
    }
    tbody td{ background:#fff; padding:12px 10px; border-top:1px solid #eee; vertical-align:middle; }
    tbody tr:hover{ background:#fff9f2; }

    /* Badges */
    .tipo{ display:inline-block; padding:6px 12px; border-radius:16px; font-weight:700; font-size:.85rem; }
    .ingreso{ background:#e8f8ea; color:#0f5a14; border:1px solid #c7efcd; }
    .ajuste{ background:#fff9db; color:#6a5600; border:1px solid #ffe08a; }
    .salida{ background:#ffe7e5; color:#6b1204; border:1px solid #ffb3ab; }
    .devoluciones{ background:#e5f0ff; color:#075380; border:1px solid #abe4ff; }
    .badge-soft{ display:inline-block; padding:6px 10px; border-radius:14px; font-weight:700; font-size:.8rem; background:#eef2ff; color:#0b3a9b; border:1px solid #d7e0ff; }
    @media (max-width: 992px){ .toolbar{ grid-template-columns: 1fr 1fr 1fr 1fr; } }
    @media (max-width: 640px){ .toolbar{ grid-template-columns: 1fr; } .card-header{ flex-direction:column; align-items:flex-start; gap:8px; } }
  </style>
</head>
<body>
  {% include 'Inventario/navbarInventario.html' %}
  <div class="page-wrap">
    <div class="card">
      <div class="card-header">
        <div class="d-flex align-items-center">
          <span class="mark"></span>
          <span>Movimientos</span>
        </div>
        <div class="d-flex gap-2">
          {% if request.user.rol.puede_gestionar_inventario %}
          <a class="btn btn-gold" href="{% url 'inventarioAdd' %}">Añadir Movimiento</a>
          {% endif %}
          <a href="{% url 'exportar_movimientos_excel' %}?tipo={{ tipo_actual }}&fecha_desde={{ fecha_desde_actual }}&fecha_hasta={{ fecha_hasta_actual }}"
              class="btn btn-success">
              Exportar Excel
          </a>
        </div>
      </div>
      <div class="body">
          <!-- FILTROS -->
          <form method="get" class="mb-3">

            <div class="row g-2 align-items-end">

              <!-- BUSCAR SKU / PRODUCTO / PROVEEDOR -->
              <div class="col-md-4">
                <label class="form-label">Buscar</label>
                <input type="text"
                      name="busqueda"
                      placeholder="SKU, Producto, Proveedor..."
                      class="form-control"
                      value="{{ busqueda_actual }}"
                      oninput="delayedSubmit()">
              </div>

              <!-- TIPO DE MOVIMIENTO -->
              <div class="col-md-2">
                <label class="form-label">Tipo</label>
                <select name="tipo" class="form-select" onchange="this.form.submit()">
                  <option value="">Todos</option>
                  <option value="I" {% if tipo_actual == 'I' %}selected{% endif %}>Ingreso</option>
                  <option value="S" {% if tipo_actual == 'S' %}selected{% endif %}>Salida</option>
                  <option value="D" {% if tipo_actual == 'D' %}selected{% endif %}>Devoluciones</option>
                  <option value="A" {% if tipo_actual == 'A' %}selected{% endif %}>Ajustes</option>
                </select>
              </div>

              <!-- FECHA DESDE -->
              <div class="col-md-2">
                <label class="form-label">Desde</label>
                <input type="date"
                      name="fecha_desde"
                      class="form-control"
                      value="{{ fecha_desde_actual }}"
                      onchange="this.form.submit()">
              </div>

              <!-- FECHA HASTA -->
              <div class="col-md-2">
                <label class="form-label">Hasta</label>
                <input type="date"
                      name="fecha_hasta"
                      class="form-control"
                      value="{{ fecha_hasta_actual }}"
                      onchange="this.form.submit()">
              </div>

              <!-- PER PAGE -->
              <div class="col-md-2">
                <label class="form-label">Mostrar</label>
                <select name="per_page" class="form-select" onchange="this.form.submit()">
                  <option value="10" {% if per_page_actual == "10" %}selected{% endif %}>10</option>
                  <option value="20" {% if per_page_actual == "20" %}selected{% endif %}>20</option>
                  <option value="30" {% if per_page_actual == "30" %}selected{% endif %}>30</option>
                  <option value="1000" {% if per_page_actual == "1000" %}selected{% endif %}>Todos</option>
                </select>
              </div>

            </div>
          </form>
        <!-- Tabla -->
        <div class="table-wrap">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>SKU</th>
                <th>Proveedor</th>
                <th>Bodega</th>
                <th>Cantidad</th>
                <th>Lote</th>
                <th>Serie</th>
                <th>Vence</th>
                <th>Doc</th>
                <th class="text-center" style="width:220px">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for m in movimientos %}
              <tr>
                <td data-fecha="{{ m.fecha|date:'Y-m-d H:i:s' }}">{{ m.fecha }}</td>
                <td>
                  {% if m.tipo == 'I' %}
                  <span class="tipo ingreso">Ingreso</span>
                  {% elif m.tipo == 'S'%}
                  <span class="tipo salida">Salida</span>
                  {% elif m.tipo == 'D'%}
                  <span class="tipo devoluciones">Devoluciones</span>
                  {% elif m.tipo == 'A'%}
                  <span class="tipo ajuste">Ajustes</span>
                  {% else %}
                  <span class="badge-soft">N/D</span>
                  {% endif %}
                </td>
                <td>{{ m.producto.sku }}</td>
                <td>{{ m.proveedor.rut_nif }} / {{ m.proveedor.nombre_fantasia }}</td>
                <td>{{ m.bodega.nombre }}</td>
                <td>{{ m.cantidad }}</td>
                <td>
                  {% if m.lote == '' %}
                    Sin Lote
                  {% elif m.lote %}
                    {{ m.lote }}
                  {% endif %}
                </td>
                <td>
                  {% if m.serie == '' %}
                    Sin Serie
                  {% elif m.serie%}
                    {{ m.serie }}
                  {% endif %}  
                </td>
                <td>
                  {% if m.fechaVencimiento == None  %}
                    Sin fecha vencimiento
                  {% elif m.fechaVencimiento %}
                    {{ m.fechaVencimiento }}
                  {% endif %}
                </td>
                <td>{{ m.doc_referencia }}</td>
                <td class="text-center">
                  <div class="d-inline-flex gap-2">
                    {% if request.user.rol.puede_gestionar_inventario %}
                    <a href="{% url 'inventarioUpdate' m.id %}" class="btn btn-sm btn-edit">Editar</a>
                    {% endif %}
                    {% if request.user.rol.puede_gestionar_inventario %}
                    <button class="btn btn-sm btn-delete"
                            data-url="{% url 'inventarioDelete' m.id %}"
                            onclick="confirmarEliminacion(this)">
                      Eliminar
                    </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="11" class="text-center py-4 text-muted">No hay usuarios que coincidan con el filtro.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      <!-- PAGINADOR -->
      {% with u_s=request.GET.s u_tipo=request.GET.tipo u_fdesde=request.GET.fdesde u_fhasta=request.GET.fhasta u_per_page=request.GET.per_page|default:'10' %}
      <div class="pagination-wrapper"  style="overflow-x:auto; white-space:nowrap; padding:0.5rem;">
        <ul class="pagination">

          {% if movimientos.has_previous %}
            <li class="page-item">
              <a class="page-link"
                href="?page={{ movimientos.previous_page_number }}
                        &busqueda={{ u_busqueda }}
                        &tipo={{ u_tipo }}
                        &fecha_desde={{ u_fdesde }}
                        &fecha_hasta={{ u_fhasta }}
                        &per_page={{ u_per_page }}">
                Anterior
              </a>
            </li>
          {% endif %}

          {% for num in movimientos.paginator.page_range %}
            <li class="page-item {% if movimientos.number == num %}active{% endif %}">
              <a class="page-link"
                href="?page={{ num }}
                        &busqueda={{ u_busqueda }}
                        &tipo={{ u_tipo }}
                        &fecha_desde={{ u_fdesde }}
                        &fecha_hasta={{ u_fhasta }}
                        &per_page={{ u_per_page }}">
                {{ num }}
              </a>
            </li>
          {% endfor %}

          {% if movimientos.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ movimientos.next_page_number }}
                &s={{ u_s }}
                &tipo={{ u_tipo }}
                &fdesde={{ u_fdesde }}
                &fhasta={{ u_fhasta }}
                &per_page={{ u_per_page }}">
                Siguiente
              </a>
            </li>
          {% endif %}

        </ul>
      </div>

      {% endwith %}
      </div>
    </div>
  </div>

  <script>
    // Confirmación de eliminación
    function confirmarEliminacion(btn) {
      const url = btn.getAttribute('data-url');
      Swal.fire({
        icon: 'warning',
        title: '¿Eliminar movimiento?',
        text: "Esta acción eliminará el movimiento de forma permanente.",
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            icon: "success",
            title: "¡Eliminado!",
            text: "Movimiento eliminado de la base de datos",
            showConfirmButton: false,
            timer: 1500
          }).then(() => { window.location.href = url; });
        }
      });
    }
  </script>
  <script>
let timeout = null;

function delayedSubmit() {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
        document.forms[0].submit();
    }, 500);
}
</script>
</body>
</html>
