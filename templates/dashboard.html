<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard · Dulcería Lilis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons + Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ===== Paleta corporativa ===== */
    :root{
      --brand-red:#c8102e;
      --brand-red-700:#a40d25;
      --brand-red-50:#fff5f7;
      --brand-gold:#d4af37;
      --brand-gold-700:#b89617;
      --brand-gold-100:#fcf6e6;
      --ink:#1c1d22;
      --muted:#6b7280;
      --border:#e8e8e8;
      --bg:#ffffff;
      --page:#fafafa;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:16px;
    }

    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, var(--brand-red-50), transparent),
                  radial-gradient(1000px 500px at 100% 0, #fff8e6, transparent),
                  linear-gradient(180deg, var(--page), #fff);
    }

    /* ===== Header ===== */
    .page{ padding:28px 12px; }
    .topbar{
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      margin-bottom:18px;
    }
    .title{
      display:flex; align-items:center; gap:12px; margin:0;
      font-weight:900;
    }
    .title-badge{
      display:inline-flex; width:12px; height:28px; border-radius:10px;
      background: linear-gradient(180deg, var(--brand-gold), var(--brand-gold-700));
      box-shadow:0 6px 14px rgba(212,175,55,.35);
    }

    /* ===== Quick actions (botones grandes rojos) ===== */
    .quick-actions{
      display:grid;
      grid-template-columns: repeat(4, minmax(220px, 1fr));
      gap:14px;
      margin-bottom:18px;
    }

    .qa{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      border:none;
      border-radius:18px;
      padding:16px 14px;
      background: linear-gradient(180deg, var(--brand-red), var(--brand-red-700));
      color:#fff;
      font-weight:900;
      text-decoration:none;
      box-shadow: 0 10px 20px rgba(200,16,46,.25);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    .qa i{
      font-size:22px;
    }

    .qa:focus-visible{
      outline:3px solid var(--brand-gold);
      outline-offset:3px;
    }

    .qa:hover{
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow:0 16px 26px rgba(200,16,46,.35);
    }

    .qa:active{
      transform: scale(.98);
      filter: brightness(.9);
    }

    @media (max-width:992px){
      .quick-actions{ grid-template-columns: 1fr; }
    }

    /* ===== Cards/KPI ===== */
    .card{
      border-radius: var(--radius);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      background: #fff;
    }
    .card-kpi{
      position:relative; overflow:hidden; padding:18px 16px;
    }
    .card-kpi .muted{ color:var(--muted); font-weight:700; letter-spacing:.2px; }
    .card-kpi .stat{ font-size:34px; font-weight:900; }
    .card-kpi::after{
      content:""; position:absolute; right:-40px; top:-40px; width:140px; height:140px; border-radius:50%;
      background: radial-gradient(closest-side, var(--brand-gold), transparent);
      opacity:.25; pointer-events:none;
    }

    .btn-pill{ border-radius:999px; }
    .btn-brand{
      background: linear-gradient(180deg, var(--brand-red), var(--brand-red-700));
      border:none; color:#fff;
    }
    .btn-brand:hover{ filter:brightness(.98); color:#fff; }

    .panel-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;
      border-bottom:2px solid var(--brand-gold); padding-bottom:6px;
    }
    .panel-title{ font-size:1rem; font-weight:800; margin:0; }

    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:12px; }
    thead th{ background:linear-gradient(180deg, #fff, var(--brand-gold-100)); }

    @media (prefers-reduced-motion:no-preference){
      .fade-in{ animation:fade .35s ease both; }
      @keyframes fade{ from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none} }
    }
  </style>
</head>
<body>
  <div class="page container-xxl">

    <div class="topbar d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h1 class="title h3 m-0">
        <span class="title-badge" aria-hidden="true"></span>
        Dashboard · Dulcería Lilis
      </h1>

      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-brand btn-pill" onclick="init()" aria-label="Refrescar dashboard">
          <i class="bi bi-arrow-clockwise me-1"></i> Refrescar
        </button>

        <a href="{% url 'login' %}" class="btn btn-sm btn-danger btn-pill" aria-label="Cerrar sesión">
          <i class="bi bi-box-arrow-right me-1"></i> Cerrar Sesión
        </a>
      </div>
    </div>

    <!-- Accesos rápidos grandes -->
    <nav class="quick-actions" aria-label="Accesos rápidos">
      {% if request.user.rol.puede_gestionar_usuarios or request.user.rol.puede_ver_usuarios %}
      <a class="qa users" href="{% url 'usuarioLista' %}">
        <i class="bi bi-people-fill"></i> <span>Panel de Usuarios</span>
      </a>
      {% endif %}
      {% if request.user.rol.puede_gestionar_productos or request.user.rol.puede_ver_productos %}
      <a class="qa products" href="{% url 'productos' %}">
        <i class="bi bi-box-seam"></i> <span>Panel de Productos</span>
      </a>
      {% endif %}
      {% if request.user.rol.puede_gestionar_proveedores or request.user.rol.puede_ver_proveedores %}
      <a class="qa providers" href="{% url 'lista_proveedores' %}">
        <i class="bi bi-truck"></i> <span>Panel de Proveedores</span>
      </a>
      {% endif %}
      {% if request.user.rol.puede_gestionar_inventario or request.user.rol.puede_ver_reportes %}
      <a class="qa inventario just" href="{% url 'inventarioLista' %}">
        <i class="bi bi-boxes"></i> <span>Inventario</span>
      </a>
      {% endif %}
    </nav>

    <!-- KPIs -->
    <div class="row g-3 mb-2">
      <div class="col-12 col-sm-6 col-lg-3 fade-in">
        <div class="card card-kpi">
          <div class="muted">Productos</div>
          <div id="kpiProductos" class="stat">–</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3 fade-in">
        <div class="card card-kpi">
          <div class="muted">Proveedores</div>
          <div id="kpiProveedores" class="stat">–</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3 fade-in">
        <div class="card card-kpi">
          <div class="muted">Usuarios</div>
          <div id="kpiUsuarios" class="stat">–</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3 fade-in">
        <div class="card card-kpi">
          <div class="muted">Stock bajo (&lt; 10)</div>
          <div id="kpiLow" class="stat">–</div>
        </div>
      </div>
    </div>

    <!-- Gráficas -->
    <div class="row g-3">
      <!-- Izquierda: rueda (productos por categoría) -->
      <div class="col-12 col-lg-6 fade-in">
        <div class="card p-3 h-100">
          <div class="panel-head">
            <h2 class="panel-title m-0">
              <i class="bi bi-pie-chart me-1"></i> Productos por categoría
            </h2>
            <div class="d-flex gap-2">
              <a class="btn btn-sm btn-outline-secondary btn-pill" href="{% url 'export_csv' 'productos' %}">
                <i class="bi bi-filetype-csv"></i> CSV
              </a>
            </div>
          </div>
          <canvas id="chartByCategory" height="140" aria-label="Gráfico productos por categoría" role="img"></canvas>
        </div>
      </div>

      <!-- Derecha: 3 gráficas apiladas -->
      <div class="col-12 col-lg-6 d-flex flex-column gap-3 fade-in">
        <div class="card p-3">
          <div class="panel-head">
            <h2 class="panel-title m-0">
              <i class="bi bi-activity me-1"></i> Altas de productos (12 meses)
            </h2>
          </div>
          <canvas id="chartMonthlyProducts" height="120" aria-label="Altas de productos en 12 meses" role="img"></canvas>
        </div>

        <div class="card p-3">
          <div class="panel-head">
            <h2 class="panel-title m-0">
              <i class="bi bi-building-gear me-1"></i> Nuevos proveedores (12 meses)
            </h2>
          </div>
          <canvas id="chartMonthlyProviders" height="120" aria-label="Altas de proveedores en 12 meses" role="img"></canvas>
        </div>

        <div class="card p-3">
          <div class="panel-head">
            <h2 class="panel-title m-0">
              <i class="bi bi-person-check me-1"></i> Nuevos usuarios (12 meses)
            </h2>
          </div>
          <canvas id="chartMonthlyUsers" height="120" aria-label="Altas de usuarios en 12 meses" role="img"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabla: Stock bajo -->
    <div class="card p-3 mt-3 fade-in">
      <div class="panel-head">
        <h2 class="panel-title m-0"><i class="bi bi-exclamation-triangle me-1"></i> Productos con stock bajo</h2>
        <div class="d-flex gap-2 align-items-center">
          <label for="umbral" class="me-1 mb-0 fw-bold text-muted">Umbral</label>
          <input class="form-control form-control-sm" type="number" id="umbral" value="10" style="width:120px" />
          <button class="btn btn-sm btn-brand btn-pill" id="btnRefrescar">
            <i class="bi bi-arrow-repeat"></i> Actualizar
          </button>
          <a class="btn btn-sm btn-outline-secondary btn-pill" id="btnXlsxLow" href="{% url 'export_excel' 'low_stock' %}?umbral=10">
            <i class="bi bi-file-earmark-spreadsheet"></i> Excel
          </a>
          <a class="btn btn-sm btn-outline-secondary btn-pill" id="btnCsvLow" href="{% url 'export_csv' 'low_stock' %}?umbral=10">
            <i class="bi bi-filetype-csv"></i> CSV
          </a>
        </div>
      </div>
      <div class="table-wrap mt-2">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th><th>Nombre</th><th>Categoría</th><th>Stock</th>
            </tr>
          </thead>
          <tbody id="tblLowStock">
            <tr><td colspan="4" class="text-center text-muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    async function getJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    // KPIs
    async function loadKPIs(){
      const data = await getJSON("{% url 'api_summary' %}");
      document.getElementById('kpiProductos').textContent = data.total_productos;
      document.getElementById('kpiProveedores').textContent = data.total_proveedores;
      document.getElementById('kpiUsuarios').textContent   = data.total_usuarios;
      document.getElementById('kpiLow').textContent        = data.productos_stock_bajo;
    }

    // Charts
    let ch1, ch2, ch3, ch4;

    async function loadCharts(){
      const cat = await getJSON("{% url 'api_products_by_category' %}");
      ch1 && ch1.destroy();
      ch1 = new Chart(document.getElementById('chartByCategory'), {
        type: 'doughnut',
        data: { labels: cat.labels, datasets: [{ data: cat.values }] },
        options: {
          responsive:true,
          plugins:{ legend:{ position:'bottom' } },
          animation:{ duration: 600 }
        }
      });

      const pm = await getJSON("{% url 'api_products_monthly' %}");
      ch2 && ch2.destroy();
      ch2 = new Chart(document.getElementById('chartMonthlyProducts'), {
        type: 'line',
        data: { labels: pm.labels, datasets: [{ label:'Productos', data: pm.values, tension:.3, fill:true }] },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });

      const prv = await getJSON("{% url 'api_providers_monthly' %}");
      ch3 && ch3.destroy();
      ch3 = new Chart(document.getElementById('chartMonthlyProviders'), {
        type: 'bar',
        data: { labels: prv.labels, datasets: [{ label:'Proveedores', data: prv.values }] },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });

      const um = await getJSON("{% url 'api_users_monthly' %}");
      ch4 && ch4.destroy();
      ch4 = new Chart(document.getElementById('chartMonthlyUsers'), {
        type: 'bar',
        data: { labels: um.labels, datasets: [{ label:'Usuarios', data: um.values }] },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // Tabla stock bajo
    async function loadLowStock(){
      const umbral = parseInt(document.getElementById('umbral').value || '10', 10);
      const data = await getJSON("{% url 'api_low_stock' %}" + `?umbral=${umbral}`);
      const tbody = document.getElementById('tblLowStock');
      tbody.innerHTML = '';
      if(data.rows.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sin resultados</td></tr>';
      }else{
        data.rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.id}</td><td>${r.nombre}</td><td>${r.categoria || ''}</td><td>${r.stock}</td>`;
          tbody.appendChild(tr);
        });
      }
      document.getElementById('btnXlsxLow').href = "{% url 'export_excel' 'low_stock' %}" + `?umbral=${umbral}`;
      document.getElementById('btnCsvLow').href  = "{% url 'export_csv' 'low_stock' %}"  + `?umbral=${umbral}`;
    }

    async function init(){
      await loadKPIs();
      await loadCharts();
      await loadLowStock();
    }

    document.getElementById('btnRefrescar').addEventListener('click', ()=>{
      loadLowStock(); loadKPIs();
    });

    init();
  </script>
</body>
</html>
